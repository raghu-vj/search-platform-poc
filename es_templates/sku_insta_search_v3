POST _scripts/sku_insta_search_v3
{
  "script": {
    "lang": "mustache",
    "source": """
            {
              "size": 2000,
              "explain": false,
              "query": {
                "bool": {
                  "should": [
                    {
                      "nested": {
                        "path": "category",
                        "boost": 20,
                        "query": {
                          "match": {
                            "category.name.exhaustive": "{{query}}"
                          }
                        }
                      }
                    },
                    {
                      "nested": {
                        "path": "attributes",
                        "boost": 19,
                        "query": {
                          "match": {
                            "attributes.type.exhaustive": "{{query}}"
                          }
                        }
                      }
                    },
                    {
                      "nested": {
                        "path": "attributes",
                        "boost": 18,
                        "query": {
                          "match": {
                            "attributes.product_name.exhaustive": "{{query}}"
                          }
                        }
                      }
                    },
                    {
                      "nested": {
                        "path": "attributes",
                        "boost": 17,
                        "query": {
                          "match": {
                            "attributes.brand.exhaustive": "{{query}}"
                          }
                        }
                      }
                    },
                    {
                      "nested": {
                        "path": "attributes",
                        "boost": 16,
                        "query": {
                          "match": {
                            "attributes.model_name.exhaustive": "{{query}}"
                          }
                        }
                      }
                    },
                    {
                      "nested": {
                        "path": "attributes",
                        "boost": 15,
                        "query": {
                          "match": {
                            "attributes.sub_category/L3.exhaustive": "{{query}}"
                          }
                        }
                      }
                    },
                    {
                      "nested": {
                        "path": "attributes",
                        "boost": 14,
                        "query": {
                          "match": {
                            "attributes.category/I2.exhaustive": "{{query}}"
                          }
                        }
                      }
                    },
                    {
                      "nested": {
                        "path": "attributes",
                        "boost": 13,
                        "query": {
                          "match": {
                            "attributes.category/L2.exhaustive": "{{query}}"
                          }
                        }
                      }
                    },
                    {
                      "nested": {
                        "path": "attributes",
                        "boost": 12,
                        "query": {
                          "match": {
                            "attributes.super_category/L1.exhaustive": "{{query}}"
                          }
                        }
                      }
                    },
                    {
                      "nested": {
                        "path": "attributes",
                        "boost": 11,
                        "query": {
                          "match": {
                            "attributes.sub_category/I1.exhaustive": "{{query}}"
                          }
                        }
                      }
                    },
                    {
                      "nested": {
                        "path": "attributes",
                        "boost": 11,
                        "query": {
                          "match": {
                            "attributes.search_keyword.exhaustive": "{{query}}"
                          }
                        }
                      }
                    },
                    {
                      "nested": {
                        "path": "attributes",
                        "boost": 10,
                        "query": {
                          "match": {
                            "attributes.pack_type.exhaustive": "{{query}}"
                          }
                        }
                      }
                    },
                    {
                      "nested": {
                        "path": "attributes",
                        "boost": 9,
                        "query": {
                          "match": {
                            "attributes.form_factor.exhaustive": "{{query}}"
                          }
                        }
                      }
                    },
                    {
                      "nested": {
                        "path": "category",
                        "query": {
                          "multi_match": {
                            "query": "{{query}}",
                            "fields": ["category.name.exhaustive"],
                            "boost": 8
                          }
                        }
                      }
                    },
                    {
                      "nested": {
                        "path": "attributes",
                        "query": {
                          "multi_match": {
                            "query": "{{query}}",
                            "fields": [
                              "attributes.type.exhaustive",
                              "attributes.product_name.exhaustive",
                              "attributes.brand.exhaustive",
                              "attributes.model_name.exhaustive",
                              "attributes.sub_category/L3.exhaustive",
                              "attributes.category/I2.exhaustive",
                              "attributes.category/L2.exhaustive",
                              "attributes.super_category/L1.exhaustive",
                              "attributes.sub_category/I1.exhaustive",
                              "attributes.pack_type.exhaustive",
                              "attributes.form_factor.exhaustive",
                              "attributes.search_keyword.exhaustive"
                            ]
                          }
                        }
                      }
                    },
                    {
                      "nested": {
                        "path": "attributes",
                        "boost" : 2,
                        "query": {
                          "prefix": {
                            "attributes.product_name.exhaustive": {
                              "value": "{{query}}"
                            }
                          }
                        }
                      }
                    },
                    {
                      "nested": {
                        "path": "attributes",
                        "query": {
                          "multi_match": {
                            "query": "{{query}}",
                            "fields": [
                              "attributes.type.partial",
                              "attributes.product_name.partial",
                              "attributes.brand.partial",
                              "attributes.model_name.partial",
                              "attributes.sub_category/L3.partial",
                              "attributes.category/I2.partial",
                              "attributes.category/L2.partial",
                              "attributes.super_category/L1.partial",
                              "attributes.sub_category/I1.partial",
                              "attributes.pack_type.partial",
                              "attributes.form_factor.partial",
                              "attributes.search_keyword.partial"
                            ]
                          }
                        }
                      }
                    },
                    {
                      "nested": {
                        "path": "category",
                        "query": {
                          "multi_match": {
                            "query": "{{query}}",
                            "fields": [
                              "category.product_name.partial"
                            ]
                          }
                        }
                      }
                    },
                    {
                      "nested": {
                        "path": "attributes",
                        "query": {
                          "multi_match": {
                            "query": "{{query}}",
                            "fields": [
                              "attributes.type.alternates",
                              "attributes.product_name.alternates",
                              "attributes.brand.alternates",
                              "attributes.model_name.alternates",
                              "attributes.sub_category/L3.alternates",
                              "attributes.category/I2.alternates",
                              "attributes.category/L2.alternates",
                              "attributes.super_category/L1.alternates",
                              "attributes.sub_category/I1.alternates",
                              "attributes.pack_type.alternates",
                              "attributes.form_factor.alternates",
                              "attributes.search_keyword.alternates"
                            ]
                          }
                        }
                      }
                    },
                    {
                      "nested": {
                        "path": "category",
                        "query": {
                          "multi_match": {
                            "query": "{{query}}",
                            "fields": [
                              "category.product_name.alternates"
                            ]
                          }
                        }
                      }
                    },
                    {
                        "bool" : {
                            "should" : {{#toJson}}rules{{/toJson}}{{^rules}}[ { "match":{"spin":{ "query":"xxxxx"} } }]{{/rules}}
                          }
                    }
                  ]
                }
              },
              "_source": {
                "include": [
                  "attributes", "attributes.productId", "spin"
                ]
              }
            }
        """
  }
}